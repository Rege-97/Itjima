<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itjima_server.mapper.AuditLogMapper">
  <insert id="insert" parameterType="com.itjima_server.domain.audit.AuditLog"
    useGeneratedKeys="true" keyProperty="id">
    INSERT INTO AUDIT_LOGS (agreement_id, user_id, action, detail)
    VALUES (#{agreementId}, #{userId}, #{action}, #{detail})
  </insert>
  <select id="findByAgreementId" resultType="com.itjima_server.dto.agreement.response.AgreementLogsResponseDTO">
    SELECT al.id,
           u.name AS userName,
           al.action,
           al.detail,
           al.created_at
    FROM AUDIT_LOGS al
           JOIN USERS u ON al.user_id = u.id
    WHERE al.agreement_id = #{agreementId}
    <if test="lastId != null">
      AND al.id &lt; #{lastId}
    </if>
    ORDER by al.id DESC
    LIMIT #{sizePlusOne}
  </select>
</mapper>